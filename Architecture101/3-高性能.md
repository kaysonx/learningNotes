## 从0开始学架构 - 3

###14. 高性能数据库集群：读写分离

> 并非所有系统都需要进行读写分离，根据“合适原则”的规定，先确认系统的业务量是否出现了数据库的性能问题。如果是，排查原因，如果通过优化MySQL语句 加缓存 优化中间件等方式能解决最好，如果还是达不到要求的性能指标，再读写分离
>
> 毕竟读写分离会引入新的复杂度，如数据不同步

要点：分散数据库读写操作的压力

基本原理：将数据库读写操作分散到不同的节点上

基本实现：

1. 数据库服务器搭建主从集群，一主一从、一主多从都可以
2. 数据库主机负责读写操作，从机只负责读操作
3. 数据库主机通过复制将数据同步到从机，每台数据库服务器都存储了所有的业务数据
4. 业务服务器将写操作发给数据库主机，将读操作发给数据库从机

区别于主备集群，从机是有任务的。而备机仅仅提供备份功能

设计复杂度：

1.主从复制延迟

常见解决方法：

1. 写操作后的读操作指定发给数据库主服务器 - 和业务强相关
2. 读从机失败后再读一次主机 - 二次读取，会增加主机的读操作压力
3. 关键业务读写操作全部指向主机，非关键业务采用读写分离
4. 加入缓存并设置过期时间，先从缓存获取 再从数据库中获得

2.分配机制

1. 程序代码封装
   * 代码中抽象一个数据访问层，用于实现读写操作分离和数据库服务器连接的管理
   * 实现简单 可以根据业务定制化功能
   * 不同语言无法通用 
   * 故障情况下 如果主从切换 **可能**需要所有系统都修改配置重启
   * 开源解决方案：
     * 淘宝TDDL
2. 中间件封装
   * 独立一套系统来实现读写分离 和 数据库服务器连接的管理
   * 能够支持多种编程语言，因为数据库中间件对业务服务器提供的是标准 SQL 接口
   * 数据库中间件要支持完整的 SQL 语法和数据库服务器的协议（例如，MySQL 客户端和服务器的连接协议），实现比较复杂，细节特别多，很容易出现 bug，需要较长的时间才能稳定
   * 数据库中间件自己不执行真正的读写操作，但所有的数据库操作请求都要经过中间件，中间件的性能要求也很高
   * 数据库主从切换对业务服务器无感知，数据库中间件可以探测数据库服务器的主从状态。例如，向某个测试表写入一条数据，成功的就是主机，失败的就是从机
   * 开源解决方案：
     * MySQL Router
     * 360 - Atlas

> 读写分离适用 单机并发 无法支撑并且 读的请求更多 的情形。在单机数据库情况下，表上加索引一般对 查询有优化作用 却 影响写入速度，读写分离后可以单独对读库进行优化，写库上减少索引，对读写的能力都有提升，且读的提升更多一些
>
> 不适用的情况:
>
> 1. 如果并发写入特别高，单机写入无法支撑，就不适合这种模式
> 2. 通过缓存技术或者程序优化能够满足要求

缓存一般应用于查询类业务上

### 15.高性能数据库集群：分库分表

要点：分散数据库存储的压力

